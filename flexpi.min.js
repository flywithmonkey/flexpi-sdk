flex={api_url:'http://api.flexpi.com:3001/',social:{facebook:{},browserid:{}},payment:{cart:{},transactions:{},cartData:[],paypal:{}},settings:{social:{facebook:{}},payment:{paypal:{}}}};flex.extend=function(obj1,obj2){for(var p in obj2){try{if(obj2[p].constructor==Object){obj1[p]=MergeRecursive(obj1[p],obj2[p])}else{obj1[p]=obj2[p]}}catch(e){obj1[p]=obj2[p]}}return obj1};flex.loader=function(c,d,aa){for(var b=c.length,e=b,f=function(){if(!(this.readyState&&this.readyState!=="complete"&&this.readyState!=="loaded")){this.onload=this.onreadystatechange=null;--e||d()}},g=document.getElementsByTagName("head")[0],i=function(h){var a=document.createElement("script");a.async=true;a.src=h;if(typeof aa!='undefined'){a.id=aa}a.onload=a.onreadystatechange=f;g.appendChild(a)};b;)i(c[--b])};flex.connect=function(data,callback){flex.appData=data;var scripts=[];scripts[0]=flex.api_url+'socket.io/socket.io.js';flex.loader(scripts,function(){flex.socket=io.connect(flex.api_url);flex.socket.on('connect',function(res){flex.readSettings();if(typeof callback!='undefined'){callback(res)}})})}flex.readSettings=function(){flex.socket.emit('settings',{'app_id':flex.appData.app_id},function(data){if(typeof data.code!='undefined'){flex.settings=data}else{flex.settings=flex.extend(flex.settings,data)}})}flex.stats=function(key,value,callback){flex.socket.emit('stats',{'app_id':flex.appData.app_id,'key':key,'value':value},function(res){if(typeof callback!='undefined'){callback(res)}})};flex.social.facebook.init=function(callback,lang){if(typeof flex.settings.social.facebook.appId=='undefined'){return{error:{code:401,message:"First configure FlexSocial."}}}if(typeof FB!='undefined'){if(typeof callback!='undefined'){callback()}return true};var scripts=[],facebookSettings=flex.settings.social.facebook;if(lang==undefined){lang=facebookSettings.lang}var g=document.getElementsByTagName("head")[0],a=document.createElement("div");if(g.length==0){a.id='fb-root';g.appendChild(a,g.firstChild)}scripts[0]='//connect.facebook.net/'+lang+'/all.js';flex.loader(scripts,function(){window.fbAsyncInit=function(){FB.init({appId:facebookSettings.appId,status:true,cookie:true,xfbml:true,oauth:true});if(typeof callback!='undefined'){callback()}}})}flex.social.facebook.isFacebookFrame=function(){if(window!=window.top){return true};return false}flex.social.facebook.feed=function(data,callback){flex.social.facebook.init(function(){FB.ui({method:'feed',message:data.message,name:data.name,link:data.link,picture:data.picture,},function(res){if(typeof callback!='undefined'){callback(res)}})})};flex.social.facebook.login=function(callback,scope){if(scope==undefined){scope={}}flex.social.facebook.init(function(){FB.login(function(res){if(typeof callback!='undefined'){callback(res)}},{scope:scope})})};flex.social.facebook.logout=function(callback){flex.social.facebook.init(function(){FB.logout(function(res){if(typeof callback!='undefined'){callback(res)}})})};flex.social.facebook.requests=function(data,callback){if(!flex.social.facebook.isFacebookFrame()){return false}if(data!=undefined){data=flex.extend({method:'apprequests',message:'My Great Request'},data)}flex.social.facebook.init(function(){FB.ui(data,function(res){if(typeof callback!='undefined'){callback(res)}})})};flex.social.facebook.message=function(data){var defaultData={method:'send',link:'http://www.flexpi.com',name:'FlexPi - games services'};if(data!=undefined){data=flex.extend(defaultData,data)}else{data=defaultData}flex.social.facebook.init(function(){FB.ui(data)})};flex.social.facebook.getFb=function(){return FB}flex.social.facebook.getLoginStatus=function(callback){flex.social.facebook.init(function(){FB.getLoginStatus(function(res){if(typeof callback!='undefined'){callback(res)}})})};flex.social.facebook.getUser=function(callback){flex.social.facebook.init(function(){flex.social.facebook.getLoginStatus(function(res){if(res.status==='connected'){FB.api('/me',function(res){callback(res)})}else{callback({error:{code:2500,message:"An active access token must be used to query information about the current user.",type:"OAuthException"}})}})})}flex.social.browserid.verify=function(assertion,callback){flex.socket.emit('browseridVerify',{'app_id':flex.appData.app_id,'assertion':assertion,'audience':window.location.href},function(res){if(typeof callback!='undefined'){callback(res)}})}flex.social.browserid.init=function(callback){var scripts=[],date=new Date();scripts[0]='https://browserid.org/include.js';flex.loader(scripts,function(){if(typeof callback!='undefined'){callback()}},'script-browserID')}flex.social.browserid.login=function(callback){if(document.getElementById('script-browserID')){navigator.id.get(function(assertion){if(assertion){flex.social.browserid.verify(assertion,function(res){if(typeof callback!='undefined'){callback(true,res,assertion)}})}else{if(typeof callback!='undefined'){callback(false,{})}}},{allowPersistent:true})}else{return false}}flex.social.browserid.logout=function(callback){window.navigator.id.logout(function(){if(typeof callback!='undefined'){callback()}})}flex.payment.init=function(callback,cartId){var scripts=[],date=new Date();scripts[0]='//flexpi.com/api/store.js';flex.loader(scripts,function(){if(typeof cartId=='undefined'){cartId=date.getTime()+'_'+Math.floor(Math.random()*101)}if(typeof store.get('cart')!='undefined'){flex.payment.cartData=store.get('cart')}else{flex.payment.transactions.cartId=cartId;store.set('transactions',flex.payment.transactions)}store.set('cart',flex.payment.cartData);if(typeof callback!='undefined'){callback(flex.payment.cartData)}})}flex.payment.cart.get=function(){return flex.payment.cartData}flex.payment.cart.getId=function(){if(typeof store!='undefined'){return store.get('transactions').cartId}else{return{error:{code:401,message:"First run 'flex.payment.init'."}}}}flex.payment.cart.add=function(item_name,amount,quantity,callback){var number=flex.payment.cartData.length;flex.payment.cartData[number]={'item_name':item_name,'amount':amount,'quantity':quantity};store.set('cart',flex.payment.cartData);if(typeof callback!='undefined'){callback(flex.payment.cartData)}return flex.payment.cartData[number]}flex.payment.cart.remove=function(index,callback){var temp=[];if(typeof flex.payment.cartData[index]!='undefined'){delete flex.payment.cartData[index]}for(i=0;i<=flex.payment.cartData.length;i++){if(typeof flex.payment.cartData[i]!='undefined'){temp.push(flex.payment.cartData[i])}}flex.payment.cartData=temp;store.set('cart',flex.payment.cartData);if(typeof callback!='undefined'){callback(flex.payment.cartData)}}flex.payment.transactions.get=function(transactionId,callback){flex.socket.emit('getPaymentTransaction',{'app_id':flex.appData.app_id,'transactionId':transactionId},function(res){if(typeof callback!='undefined'){callback(res)}})}flex.payment.transactions.clear=function(){if(typeof store!='undefined'){store.remove('transactions');store.remove('cart');return true}else{return{error:{code:401,message:"First run 'flex.payment.init'."}}}}flex.payment.paypal.createFormView=function(elementId,buttonValue){var container=document.getElementById(elementId);if(flex.payment.paypal.init()!=true){return flex.payment.paypal.init()}if(typeof container=='undefined'){return{error:{code:404,message:"Element "+elementId+" dont exist."}}}if(flex.payment.cartData.length==0){return{error:{code:401,message:"Cart doesn't have any items"}}}if(typeof buttonValue=='undefined'){buttonValue='Pay with Paypal'}var form=document.createElement("form");form.setAttribute('action','https://www.paypal.com/cgi-bin/webscr');form.setAttribute('method','post');form.setAttribute('id','flex-payment-paypal');var cart=document.createElement("input");cart.setAttribute('hidden',true);cart.setAttribute('name','cmd');cart.setAttribute('value','_cart');var custom=document.createElement("input");custom.setAttribute('hidden',true);custom.setAttribute('name','custom');custom.setAttribute('value',store.get('transactions').cartId+'___'+flex.appData.app_id);var upload=document.createElement("input");upload.setAttribute('hidden',true);upload.setAttribute('name','upload');upload.setAttribute('value',1);var currency=document.createElement("input");currency.setAttribute('hidden',true);currency.setAttribute('name','currency_code');currency.setAttribute('value',flex.settings.payment.paypal.currency);var notify_url=document.createElement("input");notify_url.setAttribute('hidden',true);notify_url.setAttribute('name','notify_url');notify_url.setAttribute('value','http://flexpi.com/api/payment/paypal/ipn');var business=document.createElement("input");business.setAttribute('hidden',true);business.setAttribute('name','business');business.setAttribute('value',flex.settings.payment.paypal.email);form.appendChild(cart);form.appendChild(custom);form.appendChild(upload);form.appendChild(currency);form.appendChild(business);var item_name,amount,quantity;for(i=0;i<flex.payment.cartData.length;i++){item_name=document.createElement("input");item_name.setAttribute('hidden',true);item_name.setAttribute('name','item_name_'+(i+1));item_name.setAttribute('value',flex.payment.cartData[i].item_name);amount=document.createElement("input");amount.setAttribute('hidden',true);amount.setAttribute('name','amount_'+(i+1));amount.setAttribute('value',flex.payment.cartData[i].amount.toFixed(2));quantity=document.createElement("input");quantity.setAttribute('hidden',true);quantity.setAttribute('name','quantity_'+(i+1));quantity.setAttribute('value',parseInt(flex.payment.cartData[i].quantity,10));form.appendChild(item_name);form.appendChild(amount);form.appendChild(quantity)}var submit=document.createElement("input");submit.setAttribute('type','submit');submit.setAttribute('class','flex-payment-paypal-send');submit.setAttribute('value',buttonValue);form.appendChild(submit);container.appendChild(form)}flex.payment.paypal.init=function(){if(typeof flex.settings.payment.paypal.email=='undefined'||typeof flex.settings.payment.paypal.currency=='undefined'){return{error:{code:401,message:"First configure FlexPayment for PayPal."}}}return true}